#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ WebSocket Chat –∑ React Frontend"
echo "========================================"

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ Lando –∑–∞–ø—É—â–µ–Ω–∏–π
if ! lando status > /dev/null 2>&1; then
    echo "üì¶ –ó–∞–ø—É—Å–∫ Lando..."
    lando start
else
    echo "‚úÖ Lando –≤–∂–µ –∑–∞–ø—É—â–µ–Ω–∏–π"
fi

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ PHP –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
echo "üì¶ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ PHP –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
if [ ! -d "vendor" ]; then
    echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è PHP –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
    lando composer install
else
    echo "‚úÖ PHP –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ"
fi

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ Node.js –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
echo "üì¶ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Node.js –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
if [ ! -d "node_modules" ]; then
    echo "üì¶ –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è Node.js –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
    npm install
else
    echo "‚úÖ Node.js –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ"
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ WebSocket —Å–µ—Ä–≤–µ—Ä —É —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ
echo "üîå –ó–∞–ø—É—Å–∫ WebSocket —Å–µ—Ä–≤–µ—Ä–∞..."
lando websocket &
WEBSOCKET_PID=$!

# –ß–µ–∫–∞—î–º–æ —Ç—Ä–æ—Ö–∏, —â–æ–± —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–≤—Å—è
sleep 3

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π
if ps -p $WEBSOCKET_PID > /dev/null; then
    echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π (PID: $WEBSOCKET_PID)"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É WebSocket —Å–µ—Ä–≤–µ—Ä–∞"
    exit 1
fi

# –ó–∞–ø—É—Å–∫–∞—î–º–æ React –¥–æ–¥–∞—Ç–æ–∫ —É —Ñ–æ–Ω–æ–≤–æ–º—É —Ä–µ–∂–∏–º—ñ
echo "‚öõÔ∏è  –ó–∞–ø—É—Å–∫ React –¥–æ–¥–∞—Ç–∫—É..."
npm start &
REACT_PID=$!

# –ß–µ–∫–∞—î–º–æ —Ç—Ä–æ—Ö–∏, —â–æ–± React –∑–∞–ø—É—Å—Ç–∏–≤—Å—è
sleep 5

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ React –∑–∞–ø—É—â–µ–Ω–∏–π
if ps -p $REACT_PID > /dev/null; then
    echo "‚úÖ React –¥–æ–¥–∞—Ç–æ–∫ –∑–∞–ø—É—â–µ–Ω–∏–π (PID: $REACT_PID)"
else
    echo "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—É—Å–∫—É React –¥–æ–¥–∞—Ç–∫—É"
    kill $WEBSOCKET_PID 2>/dev/null
    exit 1
fi

echo ""
echo "üéâ –ü—Ä–æ–µ–∫—Ç —É—Å–ø—ñ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∏–π!"
echo "=========================="
echo "üåê React –¥–æ–¥–∞—Ç–æ–∫: http://localhost:3000"
echo "üîå WebSocket —Å–µ—Ä–≤–µ—Ä: ws://localhost:8080"
echo "üìä –°—Ç–∞—Ç—É—Å: lando php check-status.php"
echo ""
echo "–î–ª—è –∑—É–ø–∏–Ω–∫–∏ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å Ctrl+C"

# –§—É–Ω–∫—Ü—ñ—è –æ—á–∏—â–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ñ
cleanup() {
    echo ""
    echo "üõë –ó—É–ø–∏–Ω–∫–∞ –ø—Ä–æ–µ–∫—Ç—É..."
    kill $WEBSOCKET_PID 2>/dev/null
    kill $REACT_PID 2>/dev/null
    echo "‚úÖ –ü—Ä–æ–µ–∫—Ç –∑—É–ø–∏–Ω–µ–Ω–æ"
    exit 0
}

# –û–±—Ä–æ–±–∫–∞ —Å–∏–≥–Ω–∞–ª—ñ–≤ –¥–ª—è –∫–æ—Ä–µ–∫—Ç–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
trap cleanup SIGINT SIGTERM

# –û—á—ñ–∫—É—î–º–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
wait 