#!/bin/bash

echo "üåê –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –¥–æ WebSocket —Å–µ—Ä–≤–µ—Ä–∞"
echo "=================================================="

# –û—Ç—Ä–∏–º—É—î–º–æ IP –∞–¥—Ä–µ—Å—É
IP_ADDRESS=$(ip addr show | grep "inet " | grep -v 127.0.0.1 | head -1 | awk '{print $2}' | cut -d'/' -f1)
echo "üìç IP –∞–¥—Ä–µ—Å–∞: $IP_ADDRESS"
echo "üîå –ü–æ—Ä—Ç: 8080"
echo ""

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π
echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
if pgrep -f "websocket-server.php" > /dev/null; then
    echo "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω–∏–π"
else
    echo "‚ùå WebSocket —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω–∏–π"
    echo "–ó–∞–ø—É—Å—Ç—ñ—Ç—å: lando websocket"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø–æ—Ä—Ç —Å–ª—É—Ö–∞—î
echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø–æ—Ä—Ç—É..."
if netstat -tlnp | grep ":8080 " > /dev/null; then
    echo "‚úÖ –ü–æ—Ä—Ç 8080 –≤—ñ–¥–∫—Ä–∏—Ç–∏–π"
else
    echo "‚ùå –ü–æ—Ä—Ç 8080 –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π"
    exit 1
fi

# –¢–µ—Å—Ç—É—î–º–æ HTTP –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
echo "üîç –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è HTTP –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è..."
HTTP_RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" http://$IP_ADDRESS:8080)
if [ "$HTTP_RESPONSE" = "426" ]; then
    echo "‚úÖ HTTP –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –ø—Ä–∞—Ü—é—î (–æ—á—ñ–∫—É—î—Ç—å—Å—è WebSocket upgrade)"
else
    echo "‚ùå HTTP –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –Ω–µ –ø—Ä–∞—Ü—é—î (–∫–æ–¥: $HTTP_RESPONSE)"
fi

echo ""
echo "üì° URL –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è:"
echo "   ws://$IP_ADDRESS:8080"
echo ""
echo "üåê –¢–µ—Å—Ç–æ–≤–∏–π —Ñ–∞–π–ª: test-external-websocket.html"
echo ""
echo "üì± –î–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∑ —ñ–Ω—à–æ–≥–æ –ø—Ä–∏—Å—Ç—Ä–æ—é:"
echo "   1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä –Ω–∞ —ñ–Ω—à–æ–º—É –ø—Ä–∏—Å—Ç—Ä–æ—ó"
echo "   2. –ü–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –∞–¥—Ä–µ—Å–æ—é: http://$IP_ADDRESS:8080"
echo "   3. –ê–±–æ –≤—ñ–¥–∫—Ä–∏–π—Ç–µ test-external-websocket.html"
echo ""
echo "üîí –ë—Ä–∞–Ω–¥–º–∞—É–µ—Ä: $(sudo ufw status | head -1)" 